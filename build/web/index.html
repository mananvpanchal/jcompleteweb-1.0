<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html ng-app="testApp">
    <head>
        <title>Application</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="javascript/angular.min.js"></script>
        <script src="javascript/angular-route.min.js"></script>
        <script>
            var jwToken = null;
            var testApp = angular.module("testApp", ["ngRoute"]);

            testApp.run(function($rootScope, $templateCache) {
                $rootScope.$on('$viewContentLoaded', function() {
                    $templateCache.removeAll();
                });
            });

            testApp.factory("$tokenHolder", function() {
                //alert("TokenHolder");
                return {
                    jwToken: null,
                    setToken: function(token) {
                        this.jwToken = token;
                    },
                    getToken: function() {
                        return this.jwToken;
                    }
                };
            });

            testApp.factory("myHttpInterceptor", ["$q", "$tokenHolder", function(q, tokenHolder) {
                    //alert("Interceptor");
                    return {
                        "request": function(config) {
                            //alert(JSON.stringify(config));
                            config.headers.jwtoken = JSON.stringify(tokenHolder.getToken());
                             //alert(JSON.stringify(config));
                            return config;
                        }
                    };
                }]);

            testApp.config(["$routeProvider", "$httpProvider", function(routeProvider, httpProvider) {
                    httpProvider.interceptors.push("myHttpInterceptor");
                    routeProvider.
                            when("/", {
                                templateUrl: "templates/open/login.html",
                                controller: "LoginCtrl"
                            }).
                            when("/home", {
                                templateUrl: "templates/restricted/home.html",
                                controller: "HomeCtrl"
                            }).
                            otherwise({
                                redirectTo: "/"
                            });
                }]);
            testApp.controller("LoginCtrl", ["$scope", "$http", "$location", "$tokenHolder", function(scope, http, location, tokenHolder) {
                    //alert("Login Controller");
                    scope.doLogin = function(username, password) {
                        var cred = {
                            "username": username,
                            "password": password
                        };
                        http.post("webresources/dologin", cred).
                                success(function(data) {
                                    tokenHolder.setToken(data);
                                    alert("success login");
                                    location.path("/home");
                                }).
                                error(function(data, status) {
                                    alert(status);
                                });
                    };
                }]);
            testApp.controller("HomeCtrl", ["$scope", "$http", "$tokenHolder", function(scope, http, tokenHolder) {
                    //alert("Home controller");
                    scope.doWork = function() {
                        http.post("webresources/restricted/home5", {criteria : "manan"}).
                                success(function(data) {
                                    //alert(JSON.stringify(data));
                                    alert(data.data);
                                }).
                                error(function(data, status) {
                                    alert(status);
                                });
                    };
                }]);</script>
    </head>
    <body>
        <div ng-view></div>
    </body>
</html>
